# å¯¼å…¥æ‰€éœ€çš„åº“
from langchain_cohere import CohereRerank
from langchain_core.documents import Document
from langchain_community.retrievers import BM25Retriever
from dotenv import load_dotenv
load_dotenv()

"""
Cohereé‡æ’ç®—æ³•å®ç°

Cohere Rerankæ˜¯ç”±Cohereå…¬å¸æä¾›çš„å•†ä¸šçº§é‡æ’APIæœåŠ¡ï¼ŒåŸºäºå…ˆè¿›çš„è¯­è¨€æ¨¡å‹æŠ€æœ¯ã€‚

æ ¸å¿ƒç‰¹ç‚¹ï¼š
1. ä¼ä¸šçº§æ€§èƒ½ï¼šåŸºäºå¤§è§„æ¨¡é¢„è®­ç»ƒæ¨¡å‹ï¼Œå…·å¤‡å¼ºå¤§çš„è¯­ä¹‰ç†è§£èƒ½åŠ›
2. å¤šè¯­è¨€æ”¯æŒï¼šæ”¯æŒåŒ…æ‹¬ä¸­æ–‡åœ¨å†…çš„å¤šç§è¯­è¨€çš„é‡æ’ä»»åŠ¡
3. å³ç”¨å³å¾—ï¼šæ— éœ€æœ¬åœ°éƒ¨ç½²æ¨¡å‹ï¼Œé€šè¿‡APIè°ƒç”¨å³å¯ä½¿ç”¨
4. æŒç»­ä¼˜åŒ–ï¼šæ¨¡å‹æŒç»­æ›´æ–°ï¼Œæ€§èƒ½ä¸æ–­æå‡

æŠ€æœ¯ä¼˜åŠ¿ï¼š
- é«˜ç²¾åº¦ï¼šåŸºäºå…ˆè¿›çš„Transformeræ¶æ„å’Œå¤§è§„æ¨¡è®­ç»ƒæ•°æ®
- ä½å»¶è¿Ÿï¼šä¼˜åŒ–çš„æ¨ç†å¼•æ“ï¼Œæ”¯æŒå®æ—¶é‡æ’éœ€æ±‚
- æ˜“é›†æˆï¼šæ ‡å‡†çš„REST APIæ¥å£ï¼Œæ˜“äºé›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ
- å¯æ‰©å±•ï¼šæ”¯æŒå¤§æ‰¹é‡æ–‡æ¡£çš„å¹¶è¡Œé‡æ’å¤„ç†

é€‚ç”¨åœºæ™¯ï¼š
- å•†ä¸šçº§æœç´¢ç³»ç»Ÿ
- å¯¹ç²¾åº¦è¦æ±‚è¾ƒé«˜çš„åº”ç”¨
- å¿«é€ŸåŸå‹å¼€å‘å’Œæµ‹è¯•
- å¤šè¯­è¨€æ£€ç´¢ç³»ç»Ÿ

æˆæœ¬è€ƒè™‘ï¼š
- æŒ‰APIè°ƒç”¨æ¬¡æ•°è®¡è´¹
- é€‚åˆä¸­å°è§„æ¨¡åº”ç”¨æˆ–å¯¹æˆæœ¬ä¸æ•æ„Ÿçš„åœºæ™¯
- å»ºè®®åœ¨å¼€å‘é˜¶æ®µè¿›è¡Œæˆæœ¬è¯„ä¼°
"""

print("ğŸ”„ åˆå§‹åŒ–Cohereé‡æ’æœåŠ¡...")

# 1. APIå¯†é’¥é…ç½®
print("ğŸ” é…ç½®Cohere APIå¯†é’¥...")
print("ğŸ“ è·å–APIå¯†é’¥åœ°å€ï¼šhttps://dashboard.cohere.com/api-keys")

# è·å–Cohere API key - ä¸¤ç§é…ç½®æ–¹å¼
import os

# æ–¹å¼1ï¼šä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆæ¨èï¼‰
api_key_from_env = os.getenv('CO_API_KEY')

# æ–¹å¼2ï¼šç›´æ¥è®¾ç½®ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
api_key = 'XXXX'  # è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…APIå¯†é’¥
os.environ['CO_API_KEY'] = api_key

if api_key_from_env:
    print("âœ… ä»ç¯å¢ƒå˜é‡æˆåŠŸè¯»å–APIå¯†é’¥")
else:
    print("âš ï¸  ä½¿ç”¨ç¡¬ç¼–ç APIå¯†é’¥ï¼ˆè¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰")

print("ğŸ”’ å®‰å…¨æé†’ï¼šè¯·ç¡®ä¿APIå¯†é’¥çš„å®‰å…¨ï¼Œä¸è¦å°†å…¶æäº¤åˆ°ä»£ç ä»“åº“")

# 2. å‡†å¤‡ç¤ºä¾‹æ–‡æ¡£
print("\nğŸ“‹ å‡†å¤‡æµ‹è¯•æ–‡æ¡£...")
documents = [
    Document(
        page_content="äº”å°å±±æ˜¯ä¸­å›½å››å¤§ä½›æ•™åå±±ä¹‹ä¸€ï¼Œä»¥æ–‡æ®Šè©è¨é“åœºé—»åã€‚",
        metadata={"source": "å±±è¥¿æ—…æ¸¸æŒ‡å—", "category": "ä½›æ•™æ–‡åŒ–", "location": "å¿»å·å¸‚"}
    ),
    Document(
        page_content="äº‘å†ˆçŸ³çªŸæ˜¯ä¸­å›½ä¸‰å¤§çŸ³çªŸä¹‹ä¸€ï¼Œä»¥ç²¾ç¾çš„ä½›æ•™é›•å¡‘è‘—ç§°ã€‚",
        metadata={"source": "å±±è¥¿æ—…æ¸¸æŒ‡å—", "category": "çŸ³çªŸè‰ºæœ¯", "location": "å¤§åŒå¸‚"}
    ),
    Document(
        page_content="å¹³é¥å¤åŸæ˜¯ä¸­å›½ä¿å­˜æœ€å®Œæ•´çš„å¤ä»£å¿åŸä¹‹ä¸€ï¼Œè¢«åˆ—ä¸ºä¸–ç•Œæ–‡åŒ–é—äº§ã€‚",
        metadata={"source": "å±±è¥¿æ—…æ¸¸æŒ‡å—", "category": "å¤å»ºç­‘", "location": "æ™‹ä¸­å¸‚"}
    )
]

print(f"æ–‡æ¡£æ•°é‡: {len(documents)}")
for i, doc in enumerate(documents, 1):
    print(f"  æ–‡æ¡£ {i}:")
    print(f"    å†…å®¹: {doc.page_content}")
    print(f"    æ¥æº: {doc.metadata.get('source', 'æœªçŸ¥')}")
    print(f"    ç±»åˆ«: {doc.metadata.get('category', 'æœªçŸ¥')}")
    print(f"    ä½ç½®: {doc.metadata.get('location', 'æœªçŸ¥')}")

# 3. åˆ›å»ºBM25æ£€ç´¢å™¨ï¼ˆä½œä¸ºåˆå§‹æ£€ç´¢ï¼‰
print(f"\nğŸ” åˆ›å»ºBM25åˆå§‹æ£€ç´¢å™¨...")
print("  BM25ç”¨äºç¬¬ä¸€é˜¶æ®µæ£€ç´¢ï¼Œæä¾›å€™é€‰æ–‡æ¡£é›†åˆ")
retriever = BM25Retriever.from_documents(documents)
retriever.k = 3  # è®¾ç½®è¿”å›å‰3ä¸ªç»“æœ
print(f"âœ… BM25æ£€ç´¢å™¨é…ç½®å®Œæˆï¼Œè¿”å›Top-{retriever.k}ç»“æœ")

# 4. è®¾ç½®Cohereé‡æ’åºå™¨
print(f"\nğŸ¤– é…ç½®Cohereé‡æ’åºå™¨...")
reranker = CohereRerank(
    model="rerank-multilingual-v3.0"  # å¤šè¯­è¨€é‡æ’æ¨¡å‹ï¼Œæ”¯æŒä¸­æ–‡
)
print(f"ä½¿ç”¨æ¨¡å‹: rerank-multilingual-v3.0")
print("  æ¨¡å‹ç‰¹ç‚¹:")
print("  - âœ… æ”¯æŒå¤šè¯­è¨€ï¼ˆåŒ…æ‹¬ä¸­æ–‡ï¼‰")
print("  - âœ… åŸºäºå…ˆè¿›çš„Transformeræ¶æ„")
print("  - âœ… é’ˆå¯¹é‡æ’ä»»åŠ¡ä¸“é—¨ä¼˜åŒ–")
print("  - âœ… æŒç»­æ›´æ–°å’Œæ”¹è¿›")

# 5. æ‰§è¡ŒæŸ¥è¯¢å’Œé‡æ’
print(f"\nğŸ¯ å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢å’Œé‡æ’...")
query = "å±±è¥¿æœ‰å“ªäº›è‘—åçš„æ—…æ¸¸æ™¯ç‚¹ï¼Ÿ"
print(f"æŸ¥è¯¢: {query}")

print(f"\nç¬¬ä¸€é˜¶æ®µ - BM25åˆå§‹æ£€ç´¢:")
print("  ğŸ” ä½¿ç”¨BM25ç®—æ³•è¿›è¡Œåˆå§‹æ£€ç´¢...")
initial_docs = retriever.invoke(query)
print(f"  ğŸ“Š BM25æ£€ç´¢åˆ° {len(initial_docs)} ä¸ªå€™é€‰æ–‡æ¡£")

for i, doc in enumerate(initial_docs, 1):
    print(f"    {i}. {doc.page_content}")

print(f"\nç¬¬äºŒé˜¶æ®µ - Cohereé‡æ’:")
print("  ğŸ¤– è°ƒç”¨Cohere APIè¿›è¡Œè¯­ä¹‰é‡æ’...")
print("  â³ æ­£åœ¨å¤„ç†ä¸­ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰...")

try:
    # ä½¿ç”¨Cohereé‡æ’åºå™¨å¯¹BM25ç»“æœè¿›è¡Œé‡æ’
    reranked_docs = reranker.compress_documents(
        documents=initial_docs, 
        query=query
    )
    print("  âœ… Cohereé‡æ’å®Œæˆ")
    
    # 6. è¾“å‡ºé‡æ’ç»“æœ
    print(f"\n{'='*60}")
    print(f"ğŸ† Cohereé‡æ’æœ€ç»ˆç»“æœ")
    print(f"{'='*60}")
    print(f"æŸ¥è¯¢: {query}")
    print(f"\né‡æ’åºåçš„ç»“æœï¼ˆæŒ‰ç›¸å…³æ€§é™åºï¼‰:")
    
    for i, doc in enumerate(reranked_docs, 1):
        print(f"\nğŸ“„ æ’å {i}:")
        print(f"   æ–‡æ¡£å†…å®¹: {doc.page_content}")
        
        # æ˜¾ç¤ºæ–‡æ¡£å…ƒæ•°æ®
        if hasattr(doc, 'metadata') and doc.metadata:
            print(f"   æ–‡æ¡£æ¥æº: {doc.metadata.get('source', 'æœªçŸ¥')}")
            print(f"   æ™¯ç‚¹ç±»åˆ«: {doc.metadata.get('category', 'æœªçŸ¥')}")
            print(f"   æ‰€åœ¨ä½ç½®: {doc.metadata.get('location', 'æœªçŸ¥')}")
        
        # å¦‚æœæœ‰é‡æ’åˆ†æ•°ï¼Œæ˜¾ç¤ºå‡ºæ¥
        if hasattr(doc, 'score'):
            print(f"   é‡æ’åˆ†æ•°: {doc.score:.4f}")

except Exception as e:
    print(f"  âŒ Cohere APIè°ƒç”¨å¤±è´¥: {str(e)}")
    print("  ğŸ’¡ å¯èƒ½çš„åŸå› :")
    print("    - APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ")
    print("    - ç½‘ç»œè¿æ¥é—®é¢˜")
    print("    - APIé…é¢å·²ç”¨å®Œ")
    print("    - è¯·æ£€æŸ¥APIå¯†é’¥é…ç½®å’Œç½‘ç»œçŠ¶æ€")

print(f"\nğŸ“‹ Cohereé‡æ’æ€»ç»“:")
print("- âœ… ä¼ä¸šçº§æ€§èƒ½ï¼šåŸºäºå¤§è§„æ¨¡é¢„è®­ç»ƒæ¨¡å‹")
print("- âœ… å¤šè¯­è¨€æ”¯æŒï¼šåŸç”Ÿæ”¯æŒä¸­æ–‡ç­‰å¤šç§è¯­è¨€")
print("- âœ… å³ç”¨å³å¾—ï¼šæ— éœ€æœ¬åœ°éƒ¨ç½²ï¼ŒAPIè°ƒç”¨å³å¯ä½¿ç”¨")
print("- âœ… æŒç»­ä¼˜åŒ–ï¼šæ¨¡å‹å®šæœŸæ›´æ–°ï¼Œæ€§èƒ½ä¸æ–­æå‡")
print("- ğŸ’° æˆæœ¬è€ƒè™‘ï¼šæŒ‰APIè°ƒç”¨æ¬¡æ•°è®¡è´¹")
print("- ğŸ” å®‰å…¨æé†’ï¼šä¿æŠ¤å¥½æ‚¨çš„APIå¯†é’¥")
print("- ğŸ“ˆ é€‚ç”¨åœºæ™¯ï¼šå•†ä¸šçº§æœç´¢ã€å¿«é€ŸåŸå‹ã€å¤šè¯­è¨€åº”ç”¨")
