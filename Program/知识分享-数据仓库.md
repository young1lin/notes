# 第一章

## 数据抽取

![数据抽取.png](https://i.loli.net/2021/04/26/O2zsircgdJ6D5Fp.png)

## 决策支持

决策支持系统（Decision Support System）

在体系结构化环境的核心，主要存在两种数据：原始数据和导出数据。下面是其区别

|                  原始数据/操作型数据                   |  导出数据/DSS型数据  |
| :----------------------------------------------------: | :------------------: |
|                        面向应用                        |       面向主题       |
|                         详细的                         |   概要的或精细化的   |
|                   在访问瞬间是准确的                   | 代表过去的数据，快照 |
|                     为日常工作服务                     |     为管理者服务     |
|                         可更新                         |        不更新        |
|                        重复运行                        |      启发式运行      |
|                    处理需求预先可知                    |  处理需求事先不知道  |
|                   生命周期符合 SDLC                    |  完全不同的生命周期  |
|                      对性能要求高                      |    对性能要求宽松    |
|                    一次访问一个单元                    |   一次访问一个集合   |
|                      事务处理驱动                      |     分析处理驱动     |
| 就操作型数据库更新责任来说更新控制是一个主要关心的问题 |   无更新控制的问题   |
|                        高可用性                        |   宽松的可用性要求   |
|                        整体管理                        |      以子集管理      |
|                        非冗余性                        |     总是存在冗余     |
|                  静态结构；可变的内容                  |       结构灵活       |
|                    一次处理数据量小                    |   一次处理数据量大   |
|                      支持日常操作                      |     支持管理需求     |
|                        访问频繁                        |    访问很少或不多    |

下面是其他的差异

-  原始数据是维持企业日常运行所需的细节性数据；导出数据是要经过汇总或计算来满足公司管理者需要的数据。
-  原始数据可以更新；导出数据可以重新计算得出，但不能直接进行更新。
-  原始数据主要是当前值数据；导出数据通常为历史数据。
-  原始数据由以重复方式运行的过程操作；导出数据由启发式而非重复地运行的程序与过程操作。
-  操作型数据是原始的；DSS 数据是导出的。
-  原始数据支持日常工作；导出数据则支持管理工作。

**两者不能存在同一数据库中，甚至不能共存于同一个环境中**。



ODS Operational Data Store 操作性数据存储区

- 数仓的 3.6 **元数据**



### 3.17 星形链接

数据仓库设计绝对是一个适合于使用规范或关系型方法的领域。关于为什么规范化可以产生数据仓库的最优设计，有下面几个原因：

- 可以带来灵活性
- 很好地适用于粒度化的数据
- 规范化方法不是对任何给定的处理需求集合都是最优的
- 能很好地与数据模型相匹配

当然，如果整个机构都用同一个方式观察数据，对规范化模型进行一些小的调整也是可以的。

在数据仓库技术中经常提到的一种不同于数据库设计方法是多维方法。这种方法需要星形连接、事实表和维。**多维方法只适用于数据集市**，而不适合数据仓库。数据集市在很大程度上是根据需求来形成的，这与数据仓库不同。为了建立一个数据集市，首先要对在数据集市上进行的处理的需求有很多了解。一旦这些需求已知，可以将数据集市建成一个最优的星形连接结构。

但数据仓库与此有着本质不同，这是因为数据仓库是为一个非常大的群体服务的，正因为如此，数据仓库对于任何一个需求集合而言，性能和便捷性都不是最优的。数据仓库是根据企业信息需求而非部分信息需求建立的。因此，对于数据仓库建立星形连接将是一个错误，最终结果是数据仓库在牺牲所有其他群体利益的代价中对一个群体实现了最优，

多维方法对于数据集市的数据库设计的吸引力起始于数据模型。所有使用数据模型作为设计基础的实践都有一些缺点。考虑如图所示的简单数据模型。

 ![简单数据模型.png](https://i.loli.net/2021/04/26/4qKF5nWlSVjYM8h.png)

> 数据集市：数据仓库的替代品？
>
> 业界有一种建造数据仓库非常昂贵和繁琐的说法。数据仓库确实需要非常多的资源，但是建立数据仓库绝对物有所值。不建立数据仓库的观点常常导致一种比数据仓库差的产物——通常是数据集市。这样的前提是你确实是不用付出数据仓库的高昂代价和投资就可以从数据集市中得到很多收益。
>
> 从短期的角度来看，这种观点确实有一些优点。但从长期的角度来看，数据集市永不可能替代数据仓库。原因如下。

![数据仓库与数据集市的关系.png](https://i.loli.net/2021/04/26/TMzYC7mSIrpXFW6.png)

> 数据集市中的数据结构是根据部门的特殊需求而建立的。金融部门在其数据集市中有一种结构，销售部门在其数据集市中有另一种结构，而市场部门在其数据集市中又有一种与这两种都不同的结构。它们的所有结构都要依赖于数据仓库中粒度化的数据。
>
> 任何一个给定的数据集市中的数据结构都与其他数据集市的不同。数据集市一般是星形连接并且包含事实表和维表。数据集市结构一般是多维结构并由 OLAP 技术支撑。
>
> 通常数据集市数据结构贯穿整个企业，不可重用，没有灵活性，不能作为调和矛盾的基础，也不能为新出现的未知需求集合提供便利。然后，数据仓库中规范化粒度数据却正好满足所有这些要求。

### 支持操作型数据存储

一般来说 ODS 有四类：

1. 从操作环境到 ODS 的数据更新是同步进行的。
2. 从操作环境到 ODS 的数据更新有 2~3 小时间隔。
3. 从操作环境到 ODS 的数据更新夜间完成的。
4. 从数据仓库到这类 ODS 的更新是不预先规划的。

### 需求和 Zachman 框架

![Zachman框架.png](https://i.loli.net/2021/04/26/3XLM7ca2JFOsgyV.png)

![从 Zachman 框架到数据仓库开发的发展过程.png](https://i.loli.net/2021/04/26/VlZ2sM3x5K6YU9W.png)

小结

数据仓库记录的基本结构包括时戳、关键字、直接数据和二级数据。所有（以某一种形式或其他形式进行的）数据仓库数据库设计都遵循这种简单模式。

参照表应当置于数据仓库中，并与其他数据一样根据时间变化进行管理。对包含在数据仓库中的参照数据的设计有多种方法。

数据以一种称为 “时间间隔“ 的方式装载进入数据仓库。这意味着操作环境一有活动发生，数据不是马上进入数据仓库。当然也有实时数仓这一说法。

星形连接是一种经常被错误地应用于数据仓库环境的数据库设计技术。在星形连接多维方法中，数据库设计是基于一个主题域中数据的出现次数和数据的访问方式进行的。星形连接设计适用于数据集市领域，而不适用于数据仓库领域。使用星形连接来建造数据仓库是一种错误，因为将使建立起来的数据仓库对于一部分用户来说是最优的，而无法为所有其他用户带来最优的结果。

# 四、数据仓库中的粒度

大量数据需要高粒度级别，一般数据可以用低粒度级别。

随着数据量的不断增长，经常使用的数据与不经常使用的数据出现了自然的分化。不经常使用的数据有时称为睡眠数据或不活跃数据。数据仓库在建立并使用了一段时期之后，其中大部分的数据都变旧而没人使用。此时，分离这部分数据，并将它们存储到另一个种存储介质上去是非常有意义的。

1. 管理大量数据的能力

![管理大量数据的能力.png](https://i.loli.net/2021/04/30/qb7kVJijadHnBLF.png)

2. 能够管理多种介质
3. 能够轻松容易的索引和监视数据
4. 用各种不同的技术接收和传送数据
5. 允许设计者/开发者在块/页级别上以一种最佳形式决定数据的物理存放位置
6. 能够并行管理数据
7. 有很好的元数据控制
8. 数据仓库要有多种语言接口
9. 能够高效地装载数据仓库
10. 有效的使用索引
11. 能够以压缩的方式存放数据
12. 支持符合键码
13. 有效地管理变长数据
14. 能够按照需要开启和关闭锁管理程序，能够在程序员级显式控制锁管理程序
15. 能够进行单独索引
16. 能够从一批介质上将数据快速、完全地恢复

 

# 存储外部数据

需要有对应的元数据去修饰它，包含

- 文件标识符（ID）
- 进入数仓的日期
- 描述
- 来源
- 分类
- 索引字
- 清理日期
- 物理地址引用
- 长度
- 相关引用

## 外部数据存档

这个在 DWU 中不考虑。

每一条信息（外部的或其他的）都有一个有用的生命周期。一旦超出了这个生命周期，保存这些信息就不经济了。

但是此刻的中台，是需要的。

## 内部数据与外部数据的比较

可能是合并，可能是剔除外部数据。需要一个公共的主键上进行。

例如从 frmu 和 fmu 中获得数据，需要进行比对。

# 迁移到体系结构化环境





![数据化组织的工作内容.png](https://i.loli.net/2021/04/26/ls1V8FXTy6WM7hw.png)

![ ](https://i.loli.net/2021/04/26/sA5SVBZbItyRiPC.png)

# 离线/流计算开发套件

是进行大数据准实时/离线任务开发、任务调度、数据管理的工具，支持对大数据实时处理过程进行可视化管理与控制，帮助开发人员提升开发效率、快速创建准实时/离线计算任务、缩短开发周期。

![流计算开发套件.png](https://i.loli.net/2021/06/08/uO5ngvd7YtiLqN3.png)

## 数据同步模块

数据同步模块是在各个存储单元之间执行数据交换的管道。为了在数据中台中进行大规模数据集的挖掘与计算，通常的做法是在任务执行前将数据传输至数据中台，并在任务执行结束后将计算结果输出至外部存储单元。

### 全量/增量同步

在业务系统读取数据的过程中，为了最小化对业务系统的影响，通常需要进行数据的增量同步，如果数据量不大可以考虑全量同步。

![数据同步.png](https://i.loli.net/2021/06/08/ywf1jsDa6uL7rVp.png)

### 定点增量同步

部分业务数据库具备自增 ID、可靠的时间戳标识等内容，那么增量同步功能在执行数据同步时，可自动记录每次的同步点位，当下一周期运行时，自动从上次的同步点位开始同步。定点增量同步既可以减轻源库的压力，又可以保障同步的数据无遗漏、无重复。

### 整库同步

帮助提升用户效率，降低用户使用成本低的一种快捷方式，可以快速地吧一个 MySQL 数据库内所有的表一并上传到数据平台中，节省大量初始化精力。

### 分库分表（MySQL）、FTP 多路径同步

数据同步模块应当可以支持关系型数据库在分库分表模式下的数据同步工作。除了关系型数据库分库分表模式，数据同步模块还应当支持一个任务从多个 FTP 路径中读取多个文件，以便减少同步任务配置的重复性工作。

# 数据开发平台

## 数据开发平台需要支持广泛的任务类型

企业内进行数据分析的场景多种多样，周期执行的任务、临时取数、数据挖掘任务会同时存在，开发套件应当对当前较流行的大数据处理程序、开发任务、开发组件、功能组件进行封装和适配，以保证开发人员高效地使用，具体的封装和适配有以下几种。

1. Spark SQL 任务。绝大多数 Spark SQL 任务为 SQL 任务，满足周期性数据处理场景，例如数据清洗、数据统计和分析、简单分析模型等。
2. Spark。
3. PySpark
4. Hadoop MapReduce
5. 数据同步。是指在不同的存储单元之间进行数据交换，支持可视化配置数据源、目标选择、字段映射、同步速度控制等。
6. 工作流领域。多个不同类型的任务可以组合成一个工作流，以便统一管理。
7. 机器学习。
8. 深度学习。
9. Python 任务。
10. Shell

### 数据开发平台需要具备强大的调度引擎

1. 上下游调度

数据开发任务之间存在依赖关系，例如必须完成数据采集才能进行数据清洗，两者必须串行，否则只能清洗其中一部分数据，多个任务之间会形成 DAG（Directed Acyclic Graph）的状态。

![开发任务之间存在依赖关系.png](https://i.loli.net/2021/06/08/Vf34e1hCcSyAGsK.png)

2. 周期性调度

每个任务都是周期运行的，例如每天凌晨 1:00 开始抽取前一天的数据。



# 数据资产管理套件

## 数据地图

### 元数据管理

1. 数据查找

   汇聚了平台内所有数据表信息，方便数据开发人员定位所需的数据表，支持开发人员根据类目、表名、所在项目、授权状态进行过滤或直接根据表名搜索。

2. 数据表的元数据管理

   数据开发人员可以在数据平台中指定某张表后，查看此表的基本信息，包括表名、物理存储量、生命周期、是否为分区表、字段名称、字段类型、分区信息等，同时可以尽心预览，直观地查看表内的数据情况。

3. 数据血缘解析

   数据血缘解析功能自动同步任务和 SQL 代码，自动建立各个数据表的表级、字段级血缘关系，开发人员可以直接看到每个指标的 “前世今生”，以便快速排查指标问题，检查指标统计逻辑、依赖链路是否正常等。

   数据血缘解析功能会自动显示与某张表相关的处理任务，开发人员可以快速地查看详细的源码处理逻辑。

### 数据管理





# 设计数据仓库

## ODS（Operational Data Store）

从 ODS 到数据仓库有三种装载工作要做。

1. 装在档案数据
2. 装在在 ODS 中现有的数据。
3. 在上次数据仓库刷新以来在操作型环境中不断发生的更新，从操作型环境中 load to data ware house

为了限制扫描的操作型数据量，可以采用五种技术。

1. 为数据加上时间戳
2. 扫描增量文件。
3. 对作为事务处理的副产品产生的日志文件或审计文件进行扫描。
4. 修改应用程序代码
5. 前后文件比较。

## 数据/过程模型

过程模型仅仅适用于 ODS， 数据模型既可用于 ODS，也可用于数据仓库环境。

一个过程模型，一般包括以下内容（数据集市不包含此，因为是需求驱动的）。

1. 功能分解
2. 第零层上下文图
3. 数据流图
4. 结构图
5. 状态转换图
6. HIPO 图
7. 伪代码

数据仓库的数据建模分为三个层次

1. 高层建模（是实体关系图，ERD）
2. 中间层建模（数据项继承，DIS）
3. 底层建模（物理模型）

## 数据从 ODS 到数仓需要完成以下功能

1. 源数据硬件信息记录
2. 如果需要实时数据，需要在线抽取
3. 关键字重建和转换。
4. 非关键字数据从 ODS 到数仓需要重新格式化
5. 合并多数据源数据
6. 合并时需要提供关键字解析功能
7. 数据清洗
   1. 取值范围检查
   2. 交叉记录验证
   3. 格式校验
8. 赋予默认值
9. 多输入文件需要重新排序
10. 进行数据汇总。
11. 命名会变，需要有文档记录
12. 异常或非标准的格式数据，需要进行转换
13. 数仓反映的时对信息的历史需求，而 ODS 体现对当前信息的即时需求。从 ODS 到数仓时，需要加上 ODS 的时间。
14. 数仓着眼于企业的信息化需求，ODS 是到秒的日常事务需求。
15. 需要传输数仓的数据。（DataX，或者利用 Flink 的 Sink 表）

## 间接使用数仓数据时应考虑的几个因素

1. 分析程序
2. 周期性刷新
3. 在线预分析数据文件

# 维表和事实表

### 定义

维表：

> A dimension is a structure that categorizes facts and measures in order to enable users to answer business questions. In a data warehouse, dimensions provide structured labeling information to otherwise unordered numeric measures. The dimension is a data set composed of individual, non-overlapping data elements. The primary functions of dimensions are threefold: to provide filtering, grouping and labelling.

事实表：



![](D:\soft\drawio\数仓\PNG\数仓相关内容-传统数据模型适用于维表.png)

传统数据模型适用于维表（即装载数据不多的实体），而星形连接设计方法则适用于事实表（即大量装载数据的实体）

# ODS

ODS 一般来说有 4 类

1. 实时的。从操作环境到 ODS 的数据更新是同步进行的。
2. 准实时的。从操作环境到 ODS 的数据更新之间有 2~3 小时的间隔。
3. T+1 的。从操作环境到 ODS 的数据更新夜间完成。
4. 从数仓到这类 ODS 的更新是不预先规划的。

# 向下钻取分析

为了切片和分块，有必要向下钻取数据。向下钻取数据是指从一个汇总数据开始，将该汇总数据分解成一组更细致的汇总数据。通过获取汇总数据下的细节数据，管理者能够知道究竟正在发生什么事情，特别是汇总苏韩剧在哪里出现异常。

# 外部数据进入数仓

问题

1. 不规则
2. 形式可能和本地的不一样。需要在入数仓前，进行转换。
3. 不可预测。

元数据和外部数据

1. 文件标识符（ID）
2. 进入数仓的日期
3. 文件描述
4. 文件来源
5. 文件来源的日期
6. 文件的分类
7. 索引字
8. 清理日期
9. 物理地址引用
10. 文件长度
11. 相关引用



# 迁移到体系结构化环境

## 一种迁移方案

起点是企业数据模型。该数据模型描述了企业的信息需求，需要清楚的是，它描述的是企业需要的信息，而并不一定是企业当前已经具有的东西。在建立这个数据模型时，并不考虑任何技术问题。

至少要包含以下内容：

1. 企业的主要主题
2. 企业的各个主要主题的定义
3. 各个主要主题之间的关系
4. 更全面地描述各个主要主题的各个关键字和属性分组，包括：
   1. 主要主题的属性集
   2. 主要主题的关键字集
   3. 关键字集和属性集的重复组
   4. 各个主要主题域之间的连接
   5. 子类关系

数仓需要定义主题，在中台这其实已经定义过了，也就是对应的 Subject，例如智能设备主题，巡查主题，消防隐患主题等等。每个主题，都有对应的表的属性，作为其关键字。

数据仓库环境是按照反复开发方法建立起来的。在这种方法中，先建立系统的一小部分，然后再建另一小部分，这样一直下去。开发过程按照相同的路径反复进行，使得这种方法看上去总是再重复自身似的。这种不变的反复过程称为螺旋式开发。

因为螺旋式开发过程是由数据模型驱动的，所以常称为数据驱动。

# 非结构化数据和数据仓库

非结构化数据领域是指那些临时的，非正式的活动占优势的情况，例如出现在 PC 机和 Internet 网上的数据。例如

- 电子邮件
- 电子数据表
- 文档
- PDF 文件

在这里暂时不讨论这个，因为现在数据来源基本是结构化数据。

# 大型数据仓库

两个数据

1. 休眠数据或非活动数据（不常使用）
2. 活动数据（经常使用）

# 多维模型

星形连接。

星星连接的中心是一张事实表。事实表是包含大量数据值的一种结构。事实表周围是维表，用来描述事实表的某个重要方面。维表里的数据量要比事实表的少。

雪花结构

通常，星形连接只包含一张事实表，但是在数据库设计中要创建一种雪花结构的复合结构需要多张事实表结合。

在雪花结构中，不同的事实表通过共享一个或多个公共维表连接起来。有时称这些共享的维表为*一致维表*。

![](D:\soft\drawio\数仓\PNG\数仓相关内容-星形连接.png)

![](D:\soft\drawio\数仓\PNG\数仓相关内容-雪花结构.png)

# 数据仓库的使用者

1. 农民
2. 探险家
3. 矿工
4. 旅行者

## 农民（各个子系统应用开发）

应用开发团队

农民是数据仓库环境中占主导地位的使用者。行为是可预测的，做的事情很有规律。查询的类型只与索要查询的数据类型有关。

## 探险家（数据分析）

不知道自己要的东西，工作的方式不可预测。

探险家的工作方式是 “启发模式”。在启发模式下，操作这直到目前这步的结果出现，还不知道下一步要分析什么。探险家的工作基础是项目，项目结束探查过程终止。

## 矿工（数据挖掘）

那些挖掘数据、分析它们能不能说明问题的人。矿工接受别人的断言,通过工作说明断言是否正确, 或者说其真实度有多强.矿工经常使用统计工具, 且以项目为工作基础.他们提出的查询规模非常大, 工作方式是启发式的. 探险者经常与矿工一前一后地工作.探险家剔除断言和假设, 矿工搞清楚这些断言和假设地真实性.

矿工有特殊的技能(通常是数学技能), 这些技能将他们与其他的技师区分开.

## 旅行者(数据开发)

旅行者知道去哪里寻找要的东西.他们具有的知识深度不够,但是广度却绰绰有余.他们对正式和不正式的系统都很熟悉,知道如何使用互联网. 他们熟悉各种形式的元数据,清楚到哪里找到索引,如何使用索引. 他们不但熟悉结构化的数据,而且熟悉非结构化的数据. 他们熟悉源代码, 懂得如何阅读和解释源代码.

# 成本论证和 ROI 分析

ROI(**Return on Investment**) 是投资回报率的意思.



命名可能如下

![](https://static001.geekbang.org/resource/image/25/d0/251a20233507361d8795277a4ef8edd0.jpg)

-- 数据仓库需要复查





- 数据产品部门：负责数据中台、数据产品的体系规划、产品设计、规范制定、应用效果跟进，指标口径的定义和维护（有的部门是由分析师管理）。
- 数据平台部门：负责研发支撑数据中台构建的产品，例如指标系统、元数据中心、数据地图等。
- 数据开发团队：负责维护数据中台的公共数据层，满足数据产品制定的数据需求。
- 应用开发团队：负责开发数据应用产品，比如报表系统、电商中的供应链系统、高层看板、经营分析。

![](https://static001.geekbang.org/resource/image/af/52/afedf9dca0f4366ff3fad9ef2f44b952.jpg)

数据血缘以及数据字典（这里的数据字典不是 sys_dic）

# 指标

同名不同径，同径不同名。口径不清晰，口径有错误。命名难理解，计算不易懂。来源不清晰，同部不同径。

例如这里的，alarm 表是预警，其中 event_type 是 1 是火警预警，就简化成了火警。但是从 119 接入的数据，到 case_instance, 这个也叫火警。这个就有歧义了。

![](https://static001.geekbang.org/resource/image/a4/36/a45797ab82110cff7ac4e0f9b43baa36.jpg)

统一指标命名

面向主题的管理



![img](https://static001.geekbang.org/resource/image/6f/1f/6ffb4a672a9c89cb573527e83152ce1f.jpg)
