# 第三章 微服务架构中的进程间的通信

## 微服务架构中的进程间通信概述

### 交互方式

有多种客户端和服务的交互方式。

**一对一**：每个客户端请求由一个服务实例来处理。

**一对多**：每个客户端请求由多个服务实例来处理。

交互方式的第二个维度关注的是同步和异步。

**同步模式**：客户端请求需要服务端实时响应，客户端等待响应式可能导致堵塞。

**异步模式**：客户端请求不会阻塞进程，服务端的响应可是非实时的。

|          |           一对一           |           一对多            |
| :------: | :------------------------: | :-------------------------: |
| 同步模式 |         请求/响应          |             无              |
| 异步模式 | 异步请求/响应<br/>单向通知 | 发布/订阅<br/>发布/异步响应 |

### 定义 API

使用某种借口定义语言（IDL）

### API 演化

**语义化的版本控制**

看这个 http://semver.org

要求版本号由三部分组成：

MAJOR.MINOR.PATCH

- MAJOR：当你对 API 进行不兼容的更改时。
- MINOR：当你对 API 进行向后兼容的增强时。
- PATCH：当你进行向后兼容的错误修复时。

不就是开发的 1.0.0 SNAPSHOT -> 1.0.0 REALEASE

可以在 REST 的 URL 中加上 MAJOR 版本号。这个在对接的时候，用过。/test/v1 -> /test/v2

这个其实在西安那和阿里对接的时候，他们是把版本号放到末尾的。

**如果你使用的是基于 HTTP 的进程间人通信机制，例如 REST，则一种方法是在 URL 中嵌入主要版本号。例如 /v1/... 为前缀，而版本 2 路径以 /v2/... 为前缀**。

另一种选择是使用 HTTP 的内容协商机制，并在 MIME 类型中包含版本号。

GET /orders/xyz HTTP/1.1

Accept: application/vnd.example.resource+json; version=1

此请求告诉 Order Service ，它的客户端需要来自版本 1.x 的响应。

### 消息的格式

进程间通信的本质是交换信息。

消息的格式可以分为两大类：文本和二进制。

1. 文本

JSON、XML。

优点：可读性高，自描述。

缺点：消息往往过度冗长，特别是 XML。解析文本引入额外开销，尤其是消息较大。

2. 二进制

- Protocol Buffers
- Avro

Protocol Buffers 使用 tagged fields，Avro 消费者在解析消息前需要知道它的格式。

## 基于同步远程过程调用模式的通信

当使用基于远程过程调用（RPI）的进程间通信机制时，客户端向服务发送请求，服务处理该请求并发回响应。有些客户端可能会处在堵塞状态并等待响应，而其他客户端可能会有一个响应式的非阻塞架构。但与使用消息机制时不同，客户端假定响应讲及时到达。
![远程过程调用.png](https://i.loli.net/2021/04/04/IBDgEV3bfmuW5vX.png)

客户端的业务逻辑调用由 RPI 代理适配器类实现的接口。RPI 代理类向服务发出请求。RPI 服务器适配器类通过调用服务的业务逻辑来处理请求。

### 使用 REST

REST 提供了一系列架构约束，当作为整体使用时，它强调组件交互的可扩展性、接口的通用性、组件的独立部署，以及那些能减少交互延迟的中间件，它强化了安全性，也能封装遗留系统。

REST 使用 HTTP 动词来操作资源，使用 URL 引用这些资源。

REST 成熟度模型

- Level 0 ：Level 0 层级服务的客户端只是向服务端发起 HTTP POST 请求，进行服务调用。每个请求都指明了需要执行的操作、这个操作针对的目标（例如，业务对象）和必要的参数。
- Level 1：Level 1 层级的服务引入了资源的概念。要执行对资源的操作，客户端需要发出制定要执行的操作和任何参数的 POST 请求。
- Level 2 ：Level 2 层级的服务使用 HTTP 动词来执行操作。如 GET 表示获取、POST 表示创建、PUT 表示更新。请求查询和主体（如果有的话）制定操作的参数。这让服务能够借助 Web 基础设施服务，例如通过 CDN 来缓存 GET 请求。
- Level 3: Level 3 层级的服务基于 HATEOAS（Hypertext As The Engine Of Application State）原则设计，基本思想是在由 GET 请求返回的资源信息中包含链接，这些链接能够执行该资源允许的操作。

### 使用 gRPC

